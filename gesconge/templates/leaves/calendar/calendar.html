{% extends "leaves/base_leaves.html" %}

{% block page_title %}Calendrier des Congés{% endblock %}
{% block page_subtitle %}Visualisez tous les congés de l'entreprise{% endblock %}

{% block action_buttons %}
<button type="button" class="btn btn-custom-primary" onclick="printCalendar()">
    <i class="fas fa-print me-2"></i>Imprimer
</button>
<button type="button" class="btn btn-success" onclick="exportCalendar()">
    <i class="fas fa-download me-2"></i>Exporter
</button>
{% endblock %}

{% block leaves_content %}
<div class="row">
    <!-- Filtres -->
    <div class="col-lg-3">
        <div class="custom-card mb-4">
            <div class="card-header card-header-custom">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filtres
                </h5>
            </div>
            <div class="card-body">
                <form method="get" id="calendar-filters">
                    <div class="mb-3">
                        <label class="form-label">Vue</label>
                        {{ form.view_type }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Département</label>
                        {{ form.department }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Service</label>
                        {{ form.service }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Type de congé</label>
                        {{ form.leave_type }}
                    </div>
                    
                    {% if request.user.is_manager %}
                    <div class="mb-3 form-check">
                        {{ form.show_only_team }}
                        <label class="form-check-label" for="{{ form.show_only_team.id_for_label }}">
                            Afficher uniquement mon équipe
                        </label>
                    </div>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-custom-primary w-100">
                        <i class="fas fa-sync me-2"></i>Appliquer les filtres
                    </button>
                </form>
                
                <!-- Légende -->
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-palette me-2"></i>Légende
                    </h6>
                    <div id="legend" class="d-flex flex-wrap gap-2">
                        {% for type in leave_types %}
                        <div class="legend-item d-flex align-items-center mb-1">
                            <span class="legend-color me-2" style="background-color: {{ type.color }}; width: 15px; height: 15px; border-radius: 3px;"></span>
                            <small>{{ type.name }}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Statistiques rapides -->
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-chart-bar me-2"></i>Statistiques
                    </h6>
                    <div id="calendar-stats" class="small">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <div>Chargement des statistiques...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendrier -->
    <div class="col-lg-9">
        <div class="custom-card">
            <div class="card-header card-header-custom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Calendrier
                    </h5>
                    <div id="current-period" class="text-white"></div>
                </div>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
        
        <!-- Liste des congés (vue liste) -->
        <div id="list-view" class="custom-card mt-4" style="display: none;">
            <div class="card-header card-header-custom">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Liste des Congés
                </h5>
            </div>
            <div class="card-body">
                <div id="leaves-list">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <div class="mt-2">Chargement des congés...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les détails du congé -->
<div class="modal fade" id="leaveModal" tabindex="-1" aria-labelledby="leaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #10536E; color: white;">
                <h5 class="modal-title" id="leaveModalLabel">Détails du Congé</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="leaveModalBody">
                <!-- Contenu chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="#" id="leaveDetailLink" class="btn btn-custom-primary">
                    <i class="fas fa-external-link-alt me-2"></i>Voir les détails complets
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block leaves_extra_js %}
<script>
// Version simplifiée et fonctionnelle
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initialisation du calendrier...');
    
    // Attendre que FullCalendar soit chargé
    if (typeof FullCalendar === 'undefined') {
        console.error('FullCalendar non chargé, chargement...');
        // Charger FullCalendar
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js';
        script.onload = function() {
            console.log('FullCalendar chargé');
            setTimeout(initCalendar, 100);
        };
        document.head.appendChild(script);
    } else {
        initCalendar();
    }
});

function initCalendar() {
    console.log('Initialisation du calendrier avec FullCalendar v' + FullCalendar.version);
    
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
        console.error('Élément #calendar non trouvé');
        return;
    }
    
    try {
        // Configuration simplifiée
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', // Toujours utiliser dayGridMonth comme vue par défaut
            locale: 'fr',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
            },
            buttonText: {
                today: 'Aujourd\'hui',
                month: 'Mois',
                week: 'Semaine',
                day: 'Jour',
                list: 'Liste'
            },
            
            // Charger les événements
            events: function(fetchInfo, successCallback, failureCallback) {
                console.log('Chargement des événements...');
                
                // Construire l'URL
                const params = new URLSearchParams({
                    start: fetchInfo.startStr,
                    end: fetchInfo.endStr,
                    department: $('#id_department').val() || '',
                    service: $('#id_service').val() || '',
                    leave_type: $('#id_leave_type').val() || '',
                    show_only_team: $('#id_show_only_team').is(':checked') ? 'on' : ''
                });
                
                $.ajax({
                    url: '{% url "leaves:calendar_events_json" %}?' + params.toString(),
                    method: 'GET',
                    success: function(data) {
                        console.log(data.length + ' événements chargés');
                        
                        // Formater les événements pour FullCalendar
                        const events = data.map(event => ({
                            id: event.id,
                            title: event.extendedProps?.user || 'Sans nom',
                            start: event.start,
                            end: event.end,
                            backgroundColor: event.color || '#10536E',
                            borderColor: event.color || '#10536E',
                            extendedProps: event.extendedProps || {}
                        }));
                        
                        successCallback(events);
                        updateStats(events);
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur:', error);
                        // Afficher un événement de test en cas d'erreur
                        successCallback([{
                            title: 'Erreur de chargement',
                            start: new Date(),
                            backgroundColor: '#dc3545',
                            borderColor: '#dc3545'
                        }]);
                        failureCallback(error);
                    }
                });
            },
            
            // Gérer le clic sur un événement
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                
                // Si c'est un événement d'erreur
                if (info.event.title === 'Erreur de chargement') {
                    alert('Erreur de chargement des données. Veuillez réessayer.');
                    return;
                }
                
                // Rediriger vers la page de détails
                if (info.event.id) {
                    window.location.href = '/leaves/' + info.event.id + '/';
                }
            },
            
            // Personnaliser l'affichage des événements
            eventContent: function(arg) {
                const title = arg.event.title;
                return {
                    html: `
                        <div class="fc-event-main-frame">
                            <div class="fc-event-title-container">
                                <div class="fc-event-title">
                                    <i class="fas fa-user fa-xs me-1"></i>
                                    ${title}
                                </div>
                            </div>
                        </div>
                    `
                };
            }
        });
        
        // Rendre le calendrier
        calendar.render();
        console.log('Calendrier initialisé avec succès');
        
        // Stocker l'instance globalement
        window.calendarInstance = calendar;
        
        // Mettre à jour la période affichée
        updateCurrentPeriod(calendar.view);
        
        // Mettre à jour la période quand la vue change
        calendar.on('datesSet', function(info) {
            updateCurrentPeriod(info.view);
        });
        
    } catch (error) {
        console.error('Erreur d\'initialisation:', error);
        showError('Impossible de charger le calendrier: ' + error.message);
    }
}

// Fonction pour mettre à jour la période affichée
function updateCurrentPeriod(view) {
    const periodEl = document.getElementById('current-period');
    if (!periodEl) return;
    
    periodEl.textContent = view.title;
}

// Fonction pour mettre à jour les statistiques
function updateStats(events) {
    if (!events || events.length === 0) {
        $('#calendar-stats').html(`
            <div class="text-center py-3 text-muted">
                <i class="fas fa-chart-pie fa-2x mb-2"></i>
                <div>Aucune donnée</div>
            </div>
        `);
        return;
    }
    
    const total = events.filter(e => e.title !== 'Erreur de chargement').length;
    
    let html = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <strong>Total:</strong>
                <span class="badge bg-primary">${total} congé${total > 1 ? 's' : ''}</span>
            </div>
        </div>
    `;
    
    // Compter par type
    const byType = {};
    events.forEach(event => {
        if (event.extendedProps?.type) {
            byType[event.extendedProps.type] = (byType[event.extendedProps.type] || 0) + 1;
        }
    });
    
    if (Object.keys(byType).length > 0) {
        html += `<div class="mb-3"><strong>Par type:</strong></div>`;
        Object.entries(byType).forEach(([type, count]) => {
            html += `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span>${type}</span>
                    <span class="badge bg-secondary">${count}</span>
                </div>
            `;
        });
    }
    
    $('#calendar-stats').html(html);
}

// Fonction pour afficher une erreur
function showError(message) {
    alert('Erreur: ' + message);
}

// Rafraîchir le calendrier
function refreshCalendar() {
    if (window.calendarInstance) {
        window.calendarInstance.refetchEvents();
    }
}

// Gérer les filtres
$(document).ready(function() {
    // Soumission du formulaire de filtres
    $('#calendar-filters').on('submit', function(e) {
        e.preventDefault();
        refreshCalendar();
    });
    
    // Changement de filtre (rafraîchissement automatique)
    $('#calendar-filters select, #calendar-filters input[type="checkbox"]').on('change', function() {
        setTimeout(refreshCalendar, 300);
    });
});

// Fonctions globales
window.printCalendar = function() {
    window.print();
};

window.exportCalendar = function() {
    alert('Fonction export à implémenter');
};
</script>
{% endblock %}